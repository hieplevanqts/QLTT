# System Admin Integration

## Module Import Flow

1. Upload a ZIP package from **System Admin > Modules > Import**.
2. Server validates:
   - Module root structure (must contain `module.json`).
   - `module.json.id` must match folder name.
   - `basePath` unique across registry.
   - Allowlisted extensions only.
   - No path traversal or core file overwrite.
   - Size and file count limits.
3. If the module already exists, the importer creates a backup under:
   `.system_admin/backups/<moduleId>/<timestamp>`.
4. Importer mirrors files into `src/modules/<moduleId>`.
5. Registry and history are updated:
   - `.system_admin/registry.json`
   - `.system_admin/import_history.json`

## Auto-generated Installed Modules

`src/imports/installedModules.ts` is generated by the importer. It exports:

```
export { someModuleRoute } from "../modules/some-module/routes";
export const installedRoutes = [someModuleRoute, ...];
```

The main router imports `installedRoutes` once and spreads into protected routes.
Do not edit `installedModules.ts` manually.

## Menu Registry & Permissions

Menu items are stored in:
`.system_admin/menu_registry.json`

Each item:

```
{
  "id": "menu_kpi",
  "label": "KPI QLTT",
  "path": "/kpi",
  "icon": "BarChart3",
  "order": 50,
  "parentId": "menu_reports",
  "permissionsAny": ["reports:read"],
  "rolesAny": ["admin","cuc","chicuc","doi"],
  "moduleId": "kpi-qltt",
  "isEnabled": true
}
```

The UI loads menus via `/system-admin/menus` and filters by user permissions.
`rolesAny` is applied when `roleCode` is available from auth context.

## Local Files (Ignored by Git)

Add `.system_admin/` to `.gitignore`. It stores:

- `registry.json`
- `import_history.json`
- `menu_registry.json`
- `backups/<moduleId>/<timestamp>`
