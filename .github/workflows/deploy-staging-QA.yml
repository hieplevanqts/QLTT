name: Build and Deploy Pipeline

on:
  push:
    branches:
      - QA-main
  workflow_call:
    secrets:
      REGISTRY_URL:
        required: true
      REGISTRY_USERNAME:
        required: true
      REGISTRY_PASSWORD:
        required: true
      MY_GITHUB_PAT:
        required: true
      VITE_SUPABASE_URL:
        required: true
      VITE_SUPABASE_ANON_KEY:
        required: true
      PUBLIC_URL_TEST:
        required: true

jobs:
  build-and-deploy:
    runs-on: [self-hosted, Linux, X64, build-image-mappa-runner]
    env:
      FRONTEND_IMAGE_NAME: saas-go/mappa-portal
      BACKEND_IMAGE_NAME: saas-go/mappa-backend
      MANIFEST_REPO: MappaWeb/mappa-manifest
    steps:
      - name: Determine Environment and Manifest Paths
        id: env-config
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          echo "üîπ Current branch: $BRANCH_NAME"

          if [ "$BRANCH_NAME" = "main" ]; then
            echo "FE_MANIFEST_PATH=production/frontend/mappa-portal-deployment.yaml" >> $GITHUB_ENV
            echo "BE_MANIFEST_PATH=production/backend/mappa-backend-deployment.yaml" >> $GITHUB_ENV
            echo "ENV_NAME=staging" >> $GITHUB_ENV
            echo "üîπ Deploying to STAGING environment"
          elif [ "$BRANCH_NAME" = "QA-main" ]; then
            echo "FE_MANIFEST_PATH=staging/frontend/mappa-portal-deployment.yaml" >> $GITHUB_ENV
            echo "BE_MANIFEST_PATH=staging/backend/mappa-backend-deployment.yaml" >> $GITHUB_ENV
            echo "ENV_NAME=qa" >> $GITHUB_ENV
            echo "üîπ Deploying to QA environment"
          else
            echo "‚ùå Error: Unsupported branch: $BRANCH_NAME"
            exit 1
          fi

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate Short SHA & Env Vars
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          echo "COMMIT_TAG=$SHORT_SHA" >> $GITHUB_ENV

          # T·∫°o bi·∫øn FULL_IMAGE ƒë·ªÉ d√πng xuy√™n su·ªët
          FULL_IMAGE_FE="${{ secrets.REGISTRY_URL }}/${{ env.FRONTEND_IMAGE_NAME }}:$SHORT_SHA"
          FULL_IMAGE_BE="${{ secrets.REGISTRY_URL }}/${{ env.BACKEND_IMAGE_NAME }}:$SHORT_SHA"

          echo "FULL_IMAGE_FE=$FULL_IMAGE_FE" >> $GITHUB_ENV
          echo "FULL_IMAGE_BE=$FULL_IMAGE_BE" >> $GITHUB_ENV

          echo "üîπ Version to build: $SHORT_SHA"

      - name: Login to Docker Registry
        run: |
          echo "${{ secrets.REGISTRY_PASSWORD }}" | docker login ${{ secrets.REGISTRY_URL }} -u ${{ secrets.REGISTRY_USERNAME }} --password-stdin

      # BUILD & PUSH FRONTEND
      - name: Build and Push FRONTEND Image
        run: |
          echo "üöÄ Building Frontend: ${{ env.FULL_IMAGE_FE }}"
          docker build \
            --build-arg VITE_SYSTEM_ADMIN_API=${{ secrets.PUBLIC_URL_TEST }} \
            --build-arg VITE_PUBLIC_URL=${{ secrets.PUBLIC_URL_TEST }} \
            --build-arg VITE_SUPABASE_URL=${{ secrets.VITE_SUPABASE_URL }} \
            --build-arg VITE_SUPABASE_ANON_KEY=${{ secrets.VITE_SUPABASE_ANON_KEY }} \
            --build-arg PUBLIC_URL=${{ secrets.PUBLIC_URL_TEST }} \
            --build-arg SUPABASE_URL=${{ secrets.VITE_SUPABASE_URL }} \
            --build-arg SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im13dWh1aXhreWJid3Jub3FjaWJnIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NzYwNTc5MiwiZXhwIjoyMDgzMTgxNzkyfQ.181FfeKfCfZt_v21wHiOgFlzm7g-pNb-JLLjPJtixzo\
            -t ${{ env.FULL_IMAGE_FE }} \
            -f Dockerfile .

          docker push ${{ env.FULL_IMAGE_FE }}
          echo "‚úÖ Push Frontend success"

      # BUILD & PUSH BACKEND
      - name: Build and Push BACKEND Image
        run: |
          echo "üöÄ Building Backend: ${{ env.FULL_IMAGE_BE }}"
          docker build \
            -t ${{ env.FULL_IMAGE_BE }} \
            -f Dockerfile-be .

          docker push ${{ env.FULL_IMAGE_BE }}
          echo "‚úÖ Push Backend success"

      # UPDATE K8S MANIFEST
      - name: Checkout Manifest Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.MANIFEST_REPO }}
          token: ${{ secrets.MY_GITHUB_PAT }}
          path: mappa-manifest
          ref: main

      - name: Update Kubernetes Manifests
        working-directory: mappa-manifest
        run: |
          git config user.name "CI Builder"
          git config user.email "ci-bot@mappa.com"

          # Update Frontend
          if [ -f "${{ env.FE_MANIFEST_PATH }}" ]; then
            echo "üìù Updating Frontend: ${{ env.FE_MANIFEST_PATH }}"
            BASE_IMAGE_FE="${{ secrets.REGISTRY_URL }}/${{ env.FRONTEND_IMAGE_NAME }}"
            sed -i "s|image: ${BASE_IMAGE_FE}:.*|image: ${{ env.FULL_IMAGE_FE }}|g" ${{ env.FE_MANIFEST_PATH }}
          else
            echo "‚ö†Ô∏è Warning: Frontend manifest not found"
            ls -R
            exit 1
          fi

          # Update Backend
          if [ -f "${{ env.BE_MANIFEST_PATH }}" ]; then
            echo "üìù Updating Backend: ${{ env.BE_MANIFEST_PATH }}"
            BASE_IMAGE_BE="${{ secrets.REGISTRY_URL }}/${{ env.BACKEND_IMAGE_NAME }}"
            sed -i "s|image: ${BASE_IMAGE_BE}:.*|image: ${{ env.FULL_IMAGE_BE }}|g" ${{ env.BE_MANIFEST_PATH }}
          else
             echo "‚ö†Ô∏è Warning: Backend manifest not found"
             ls -R
             exit 1
          fi

          # Commit
          if git diff --quiet; then
            echo "No changes detected."
          else
            git add .
            git commit -m "chore(deploy): update images to ${{ env.COMMIT_TAG }} for ${{ env.ENV_NAME }} [skip ci]"
            git push origin main
            echo "‚úÖ All manifests updated successfully!"
          fi

      # CLEANUP (M·ªõi th√™m)
      - name: Cleanup Local Docker Images
        if: always() # Ch·∫°y ngay c·∫£ khi c√°c b∆∞·ªõc tr√™n b·ªã l·ªói
        run: |
          echo "üßπ Cleaning up local images..."
          # D√πng "|| true" ƒë·ªÉ pipeline kh√¥ng b·ªã fail n·∫øu image kh√¥ng t·ªìn t·∫°i (v√≠ d·ª• build l·ªói)
          docker rmi ${{ env.FULL_IMAGE_FE }} || echo "‚ö†Ô∏è Could not remove Frontend image"
          docker rmi ${{ env.FULL_IMAGE_BE }} || echo "‚ö†Ô∏è Could not remove Backend image"

          # (T√πy ch·ªçn) X√≥a c√°c dangling images ƒë·ªÉ gi·∫£i ph√≥ng th√™m dung l∆∞·ª£ng
          # docker image prune -f 

          echo "‚úÖ Cleanup complete."
