name: Build and Deploy Pipeline

on:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/docker-image.yml'
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      REGISTRY: ghcr.io
      USERNAME: hieplevanqts
      FRONTEND_IMAGE: ghcr.io/hieplevanqts/frontend
      BACKEND_IMAGE: ghcr.io/hieplevanqts/backend

    steps:
      # =====================
      # CHECKOUT
      # =====================
      - name: Checkout source
        uses: actions/checkout@v4

      # =====================
      # IMAGE TAG
      # =====================
      - name: Generate image tag
        run: |
          SHORT_SHA=$(echo $GITHUB_SHA | cut -c1-7)
          echo "TAG=$SHORT_SHA" >> $GITHUB_ENV

      # =====================
      # LOGIN GHCR
      # =====================
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: hieplevanqts
          password: ${{ secrets.GITHUB_TOKEN }}

      # =====================
      # BUILD FRONTEND
      # =====================
      - name: Build & Push Frontend
        run: |
          docker build \
            -f Dockerfile \
            -t $FRONTEND_IMAGE:$TAG \
            .

          docker push $FRONTEND_IMAGE:$TAG
          docker tag $FRONTEND_IMAGE:$TAG $FRONTEND_IMAGE:latest
          docker push $FRONTEND_IMAGE:latest

      # =====================
      # BUILD BACKEND
      # =====================
      - name: Build & Push Backend
        run: |
          docker build \
            -f Dockerfile-be \
            -t $BACKEND_IMAGE:$TAG \
            .

          docker push $BACKEND_IMAGE:$TAG
          docker tag $BACKEND_IMAGE:$TAG $BACKEND_IMAGE:latest
          docker push $BACKEND_IMAGE:latest

      # =====================
      # DEPLOY ON VPS (THEO ƒê√öNG √ù B·∫†N)
      # =====================
      - name: Deploy on VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 7878
          script: |
            echo "üöÄ Applying k8s manifests"
            kubectl apply -f ~/app-deploy.yaml

            echo "üîÑ Restart deployments"
            kubectl rollout restart deployment react-frontend
            kubectl rollout restart deployment node-backend

            echo "‚è≥ Waiting rollout"
            kubectl rollout status deployment react-frontend
            kubectl rollout status deployment node-backend

            echo "‚úÖ Deploy completed"
